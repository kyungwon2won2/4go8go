<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.UserMapper">

    <resultMap type="Users" id="userMap">
        <id property="userId" column="user_id" />
        <result property="email" column="email" />
        <result property="name" column="name" />
        <result property="phone" column="phone" />
        <result property="password" column="password" />
        <result property="nickname" column="nickname" />
        <result property="address" column="address" />
        <result property="birthDate" column="birth_date" />
        <result property="points" column="points" />
        <result property="rating" column="rating" />
        <result property="receiveMail" column="receive_mail" />
        <result property="emailVerified" column="email_verified" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="status" column="status" />
        <result property="deletedAt" column="deleted_at" />
        <result property="socialType" column="social_type" />
        <result property="socialId" column="social_id" />
        <collection property="roleList" resultMap="roleMap" />
    </resultMap>

    <resultMap type="UserRole" id="roleMap">
        <result property="userId" column="user_id" />
        <result property="roleName" column="role_name" />
    </resultMap>

    <select id="login" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.password, u.nickname, u.address,
               u.birth_date, u.points, u.rating, u.receive_mail, u.email_verified,
               u.created_at, u.updated_at, u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>

    <!-- 자동 생성된 키(user_id)를 반환받도록 useGeneratedKeys와 keyProperty 추가 -->
    <insert id="join" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO user(email, name, phone, password, nickname, address, birth_date, receive_mail, email_verified, social_type, social_id)
        VALUES(#{email}, #{name}, #{phone}, #{password}, #{nickname}, #{address}, #{birthDate}, #{receiveMail}, #{emailVerified}, #{socialType}, #{socialId})
    </insert>

    <insert id="insertAuth">
        INSERT INTO user_role(user_id, role_name)
        VALUES(#{userId}, #{roleName})
    </insert>

    <select id="getAllUsers" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
    </select>

    <select id="getUserById" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>
    
    <select id="findById" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE u.user_id = #{userId}
    </select>

    <select id="getUserByEmail" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.created_at, u.updated_at, u.status, u.deleted_at,
               u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>
    
    <select id="findByEmail" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE u.email = #{email}
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser" parameterType="Users">
        UPDATE user
        SET
        name = #{name},
        nickname = #{nickname},
        phone = #{phone},
        address = #{address},
        birth_date = #{birthDate},
        receive_mail = #{receiveMail},
        <if test="status != null">
            status = #{status},
        </if>
        <if test="deletedAt != null">
            deleted_at = #{deletedAt},
        </if>
        <if test="deletedAt == null">
            deleted_at = NULL,
        </if>
        <if test="password != null and password != ''">
            password = #{password},
        </if>
        updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

    <delete id="deleteUser">
        DELETE FROM user WHERE email = #{email}
    </delete>

    <!-- 오늘 생일인 사용자 목록 조회 -->
    <select id="findUsersByBirthdayToday" resultMap="userMap">
        SELECT u.user_id, u.email, u.password, u.nickname, u.address,
        u.birth_date, u.points, u.rating, u.receive_mail,
        u.created_at, u.updated_at, r.role_name
        FROM user u JOIN user_role r ON u.user_id = r.user_id
        WHERE MONTH(u.birth_date) = MONTH(CURRENT_DATE)
        AND DAY(u.birth_date) = DAY(CURRENT_DATE)
    </select>

    <!-- 이메일이 존재하는지 여부 -->
    <select id="existsByEmail" resultType="boolean">
        SELECT EXISTS (
        SELECT 1 FROM user WHERE email = #{email}
        )
    </select>

    <!-- 30일 지난 탈퇴 계정들 조회 -->
    <select id="findExpiredDeletedAccounts" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.status, u.deleted_at, u.created_at
        FROM user u
        WHERE u.status = 'DELETED' 
        AND u.deleted_at IS NOT NULL
        AND DATEDIFF(NOW(), u.deleted_at) > 30
    </select>
    
    <!-- === 완전 삭제를 위한 참조 데이터 삭제 쿼리들 === -->
    
    <!-- 1. 채팅 메시지 삭제 -->
    <delete id="deleteChatMessagesByUserId">
        DELETE FROM chat_message WHERE user_id = #{userId}
    </delete>
    
    <!-- 2. 채팅 참가자 삭제 -->
    <delete id="deleteChatParticipantsByUserId">
        DELETE FROM chat_participant WHERE user_id = #{userId}
    </delete>
    
    <!-- 3. 채팅방 삭제 (해당 유저가 생성한) -->
    <delete id="deleteChatRoomsByUserId">
        DELETE FROM chat_room WHERE user_id = #{userId}
    </delete>
    
    <!-- 4. 댓글 삭제 -->
    <delete id="deleteCommentsByUserId">
        DELETE FROM comments WHERE user_id = #{userId}
    </delete>
    
    <!-- 5. 알림 삭제 -->
    <delete id="deleteNotificationsByUserId">
        DELETE FROM notification WHERE user_id = #{userId}
    </delete>
    
    <!-- 6. 읽음 상태 삭제 -->
    <delete id="deleteReadStatusByUserId">
        DELETE FROM read_status WHERE user_id = #{userId}
    </delete>
    
    <!-- 7. 사용자 권한 삭제 -->
    <delete id="deleteUserRolesByUserId">
        DELETE FROM user_role WHERE user_id = #{userId}
    </delete>
    
    <!-- 8. 최종 사용자 삭제 -->
    <delete id="permanentlyDeleteUser">
        DELETE FROM user WHERE user_id = #{userId}
    </delete>
  
    <!-- 쿠폰 사용시 포인트 추가 -->
    <update id="updatePoint">
        UPDATE user
        SET points = points + #{discountAmount}
        WHERE user_id = #{userId}
    </update>

    <!-- === 관리자 기능을 위한 추가 쿼리들 === -->
    
    <!-- 사용자의 권한 목록 조회 -->
    <select id="getUserRolesByUserId" resultMap="roleMap">
        SELECT user_id, role_name
        FROM user_role
        WHERE user_id = #{userId}
    </select>
    
    <!-- 관리자 권한을 가진 사용자 목록 조회 -->
    <select id="getAdminUsers" resultMap="userMap">
        SELECT u.user_id, u.email, u.name, u.phone, u.nickname, u.address, u.birth_date,
               u.points, u.rating, u.receive_mail, u.email_verified, u.created_at, u.updated_at,
               u.status, u.deleted_at, u.social_type, u.social_id, r.role_name
        FROM user u LEFT JOIN user_role r ON u.user_id = r.user_id
        WHERE r.role_name = 'ROLE_ADMIN'
    </select>
    
    <!-- 특정 권한 삭제 -->
    <delete id="deleteUserRole">
        DELETE FROM user_role 
        WHERE user_id = #{userId} AND role_name = #{roleName}
    </delete>
  


    <!-- 사용자 평점 업데이트 -->
    <update id="updateUserRating">
        UPDATE users
        SET rating = #{rating}
        WHERE user_id = #{userId}
    </update>

</mapper>